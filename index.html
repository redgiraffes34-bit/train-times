<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=5.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÜ</text></svg>">
    <title>Train Times</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a1a;
        }
        
        .app-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 900px;
            margin: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 32px);
        }
        
        .app-header {
            padding: 16px 20px 12px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .app-title-icon {
            font-size: 28px;
        }
        
        .app-title-text {
            display: flex;
            flex-direction: column;
        }
        
        .app-title-text h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.02em;
        }
        
        .app-title-text span {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.15);
            border: 1px solid rgba(148, 163, 184, 0.4);
            display: flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(8px);
        }
        
        .badge-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.3);
        }
        
        .badge span {
            font-size: 11px;
        }
        
        .voice-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(191, 219, 254, 0.7);
            background: rgba(15, 23, 42, 0.12);
            cursor: pointer;
            color: #e0f2fe;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        }
        
        .voice-toggle:hover {
            background: rgba(15, 23, 42, 0.2);
            transform: translateY(-0.5px);
            box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.6);
        }
        
        .voice-toggle.active {
            background: rgba(22, 163, 74, 0.2);
            border-color: rgba(74, 222, 128, 0.8);
            color: #bbf7d0;
        }
        
        .voice-toggle-icon {
            font-size: 14px;
        }
        
        .app-main {
            padding: 16px 18px 18px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            flex: 1;
            min-height: 0;
        }
        
        .pill-row {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: space-between;
        }
        
        .pill-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pill-button {
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            background: linear-gradient(135deg, #f9fafb, #e5f0ff);
            padding: 7px 12px;
            font-size: 12px;
            color: #0f172a;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        
        .pill-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pill-button:hover:not(.disabled) {
            background: linear-gradient(135deg, #eef2ff, #dbeafe);
            transform: translateY(-0.5px);
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2);
        }
        
        .pill-button span.label {
            font-weight: 500;
        }
        
        .pill-icon {
            font-size: 16px;
        }
        
        .swap-icon {
            font-size: 18px;
        }
        
        .pill-subtext {
            font-size: 10px;
            color: #64748b;
        }
        
        .time-pill {
            border-radius: 999px;
            border: 1px dashed rgba(148, 163, 184, 0.8);
            background: rgba(15, 23, 42, 0.02);
            padding: 6px 10px;
            font-size: 11px;
            color: #475569;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .time-pill span.label {
            font-weight: 500;
        }
        
        .time-pill .time {
            font-variant-numeric: tabular-nums;
            font-weight: 600;
        }
        
        .content-card {
            background: #f8fafc;
            border-radius: 18px;
            padding: 14px 14px 12px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            padding: 3px;
            background: rgba(15, 23, 42, 0.02);
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
        }
        
        .tab-button {
            flex: 1;
            text-align: center;
            padding: 7px 8px;
            border-radius: 999px;
            border: none;
            background: transparent;
            font-size: 12px;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.2s ease, color 0.2s ease, transform 0.1s ease;
        }
        
        .tab-button span.icon {
            font-size: 14px;
        }
        
        .tab-button.active {
            background: white;
            color: #1d4ed8;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.2);
            transform: translateY(-0.5px);
        }
        
        .tab-button.active span.icon {
            transform: translateY(0);
        }
        
        .tab-button span.label {
            font-weight: 500;
        }
        
        .routes-list {
            margin-top: 4px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .route-card {
            background: white;
            border-radius: 14px;
            padding: 10px 12px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            box-shadow: 0 1px 4px rgba(15, 23, 42, 0.18);
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.15s ease;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .route-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(15, 23, 42, 0.2);
            border-color: rgba(59, 130, 246, 0.9);
        }
        
        .route-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .route-main {
            font-weight: 600;
            font-size: 14px;
            color: #0f172a;
        }
        
        .route-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            background: rgba(37, 99, 235, 0.09);
            color: #1d4ed8;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .route-badge span.icon {
            font-size: 13px;
        }
        
        .route-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }
        
        .route-meta-left {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #64748b;
        }
        
        .route-meta-left span {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .route-meta-dot {
            width: 4px;
            height: 4px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.9);
        }
        
        .route-time-estimate {
            font-size: 11px;
            color: #0f172a;
            font-weight: 500;
        }
        
        .route-time-estimate span {
            font-variant-numeric: tabular-nums;
        }
        
        .route-footnote {
            font-size: 10px;
            color: #94a3b8;
            margin-top: 2px;
        }
        
        .route-footnote strong {
            color: #64748b;
        }
        
        .results-view {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .results-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
        }
        
        .results-header h2 span {
            font-weight: 500;
            color: #1d4ed8;
        }
        
        .results-header-subtitle {
            font-size: 11px;
            color: #64748b;
            margin-top: 2px;
        }
        
        .update-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #64748b;
        }
        
        .update-pill {
            padding: 3px 8px;
            border-radius: 999px;
            background: rgba(248, 250, 252, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.5);
            font-variant-numeric: tabular-nums;
        }
        
        .refresh-btn {
            border-radius: 999px;
            border: none;
            background: #1d4ed8;
            color: white;
            padding: 6px 10px;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 1px 6px rgba(37, 99, 235, 0.45);
            transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
        }
        
        .refresh-btn.small {
            padding: 4px 8px;
            font-size: 10px;
            box-shadow: none;
        }
        
        .refresh-btn:hover {
            background: #1e40af;
            transform: translateY(-0.5px);
            box-shadow: 0 3px 10px rgba(37, 99, 235, 0.6);
        }
        
        .refresh-btn span.icon {
            font-size: 13px;
        }
        
        .journeys-container {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding-right: 4px;
        }
        
        .hero-journey {
            background: linear-gradient(135deg, #eff6ff, #eef2ff);
            border-radius: 16px;
            padding: 10px 12px;
            border: 1px solid rgba(59, 130, 246, 0.6);
            box-shadow: 0 2px 10px rgba(37, 99, 235, 0.25);
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .hero-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #1d4ed8;
        }
        
        .hero-label-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .hero-label-badge {
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(254, 249, 195, 0.8);
            border: 1px solid rgba(234, 179, 8, 0.7);
            font-size: 10px;
            color: #854d0e;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .hero-label-badge span.icon {
            font-size: 12px;
        }
        
        .speak-btn {
            border-radius: 999px;
            border: none;
            background: rgba(15, 23, 42, 0.08);
            color: #0f172a;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: background 0.15s ease, transform 0.1s ease;
        }
        
        .speak-btn:hover {
            background: rgba(15, 23, 42, 0.16);
            transform: translateY(-0.5px);
        }
        
        .hero-main {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }
        
        .hero-times {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .hero-main-time {
            font-size: 20px;
            font-variant-numeric: tabular-nums;
            font-weight: 700;
            color: #0f172a;
        }
        
        .hero-route {
            font-size: 14px;
            font-weight: 600;
            color: #0f172a;
        }
        
        .hero-subtitle {
            font-size: 11px;
            color: #1e293b;
            margin-top: 2px;
        }
        
        .hero-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #64748b;
            margin-top: 6px;
        }
        
        .hero-meta-dot {
            width: 4px;
            height: 4px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.9);
        }
        
        .hero-platform {
            padding: 4px 8px;
            border-radius: 999px;
            background: white;
            border: 1px solid rgba(148, 163, 184, 0.7);
            font-size: 11px;
            font-weight: 600;
            color: #111827;
        }
        
        .hero-platform.tbc {
            background: rgba(249, 250, 251, 0.9);
            border-style: dashed;
            color: #6b7280;
        }
        
        .hero-countdown {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            border: 1px solid rgba(22, 163, 74, 0.4);
            background: rgba(220, 252, 231, 0.9);
            padding: 4px 8px;
            font-size: 11px;
            color: #166534;
            margin-top: 8px;
            font-variant-numeric: tabular-nums;
        }
        
        .hero-countdown span.icon {
            font-size: 12px;
        }
        
        .status-badge {
            margin-left: 4px;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 500;
        }
        
        .status-ontime {
            background: rgba(22, 163, 74, 0.08);
            color: #15803d;
            border: 1px solid rgba(34, 197, 94, 0.7);
        }
        
        .status-delayed {
            background: rgba(234, 179, 8, 0.08);
            color: #854d0e;
            border: 1px solid rgba(234, 179, 8, 0.7);
        }
        
        .status-cancelled {
            background: rgba(239, 68, 68, 0.08);
            color: #b91c1c;
            border: 1px solid rgba(239, 68, 68, 0.7);
        }
        
        .journey-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }
        
        .journey-card {
            background: white;
            border-radius: 12px;
            padding: 8px 10px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
            font-size: 12px;
        }
        
        .journey-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .journey-times {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .journey-main-time {
            font-size: 15px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        
        .journey-subtitle {
            font-size: 11px;
            color: #64748b;
        }
        
        .journey-platform {
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(248, 250, 252, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.8);
            font-size: 11px;
            font-weight: 500;
        }
        
        .journey-body {
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 10px;
        }
        
        .journey-details {
            font-size: 11px;
            color: #6b7280;
        }
        
        .journey-operator {
            margin-top: 2px;
            color: #9ca3af;
            font-size: 10px;
        }
        
        .journey-summary {
            font-size: 11px;
            text-align: right;
            color: #4b5563;
        }
        
        .journey-summary span.time {
            font-variant-numeric: tabular-nums;
            font-weight: 600;
        }
        
        .no-results {
            text-align: center;
            padding: 16px 12px 12px;
            font-size: 13px;
            color: #64748b;
        }
        
        .no-results strong {
            color: #0f172a;
        }
        
        .no-results small {
            display: block;
            margin-top: 4px;
            font-size: 11px;
            color: #9ca3af;
        }
        
        .all-trains-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 4px;
        }
        
        .all-trains-card {
            background: white;
            border-radius: 10px;
            padding: 7px 9px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            font-size: 11px;
        }
        
        .all-trains-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .all-trains-main-time {
            font-variant-numeric: tabular-nums;
            font-weight: 600;
            font-size: 14px;
        }
        
        .all-trains-destination {
            font-weight: 500;
        }
        
        .all-trains-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            color: #6b7280;
        }
        
        .route-breadcrumbs {
            font-size: 11px;
            color: #64748b;
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .crumb {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .crumb span.dot {
            width: 3px;
            height: 3px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.9);
        }
        
        .crumb span.icon {
            font-size: 10px;
        }
        
        .back-btn {
            margin-top: 10px;
            border-radius: 999px;
            border: none;
            background: rgba(15, 23, 42, 0.03);
            padding: 6px 10px;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #4b5563;
            border: 1px solid rgba(148, 163, 184, 0.6);
            transition: background 0.15s ease, transform 0.1s ease;
        }
        
        .back-btn:hover {
            background: rgba(15, 23, 42, 0.06);
            transform: translateY(-0.5px);
        }
        
        .combined-journey {
            background: white;
            border-radius: 14px;
            padding: 10px 12px;
            border: 1px solid rgba(148, 163, 184, 0.55);
            box-shadow: 0 1px 4px rgba(15, 23, 42, 0.16);
            margin-bottom: 10px;
        }
        
        .combined-leg {
            background: rgba(249, 250, 251, 0.9);
            border-radius: 10px;
            padding: 7px 8px;
            border: 1px solid rgba(209, 213, 219, 0.9);
            margin-top: 6px;
        }
        
        .leg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .leg-time {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            font-size: 14px;
            color: #111827;
        }
        
        .platform {
            padding: 3px 7px;
            border-radius: 999px;
            background: white;
            border: 1px solid rgba(148, 163, 184, 0.9);
            font-size: 11px;
            font-weight: 500;
        }
        
        .platform-tbd {
            padding: 3px 7px;
            border-radius: 999px;
            background: rgba(248, 250, 252, 0.9);
            border: 1px dashed rgba(148, 163, 184, 0.9);
            font-size: 11px;
            font-weight: 500;
            color: #6b7280;
        }
        
        .connection-time {
            margin-top: 6px;
            font-size: 11px;
            padding: 5px 7px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-width: 1px;
            border-style: solid;
        }
        
        .connection-time.good {
            background: rgba(22, 163, 74, 0.06);
            border-color: rgba(22, 163, 74, 0.5);
            color: #166534;
        }
        
        .connection-time.tight {
            background: rgba(234, 179, 8, 0.06);
            border-color: rgba(234, 179, 8, 0.6);
            color: #854d0e;
        }
        
        .total-journey-time {
            margin-top: 7px;
            font-size: 11px;
            color: #4b5563;
        }
        
        .other-trains-header {
            margin: 6px 0 4px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9ca3af;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 14px 12px;
            gap: 10px;
            font-size: 12px;
            color: #64748b;
        }
        
        .loading strong {
            color: #0f172a;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border-radius: 999px;
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-top-color: #3b82f6;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .footer {
            padding: 10px 14px 12px;
            border-top: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(248, 250, 252, 0.95);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            color: #94a3b8;
        }
        
        .footer span.highlight {
            font-weight: 500;
            color: #64748b;
        }
        
        .footer a {
            color: #1d4ed8;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 640px) {
            .app-container {
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
            }
            
            .app-header {
                padding: 12px 14px 10px;
            }
            
            .app-main {
                padding: 12px 12px 14px;
            }
            
            .app-title-text h1 {
                font-size: 18px;
            }
            
            .routes-list {
                gap: 8px;
            }
            
            .hero-main-time {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="app-title">
                <div class="app-title-icon">üöÜ</div>
                <div class="app-title-text">
                    <h1>Train Times</h1>
                    <span>Live departures with smart routing</span>
                </div>
            </div>
            <div class="header-right">
                <div class="badge">
                    <div class="badge-dot"></div>
                    <span>Live National Rail data</span>
                </div>
                <button id="voiceToggle" class="voice-toggle" onclick="toggleVoice()">
                    <span class="voice-toggle-icon">üîä</span>
                    <span>Voice</span>
                </button>
            </div>
        </header>
        
        <main class="app-main">
            <div class="pill-row">
                <div class="pill-group">
                    <button class="pill-button" onclick="selectPrimaryRoute('ADD', 'LST')" title="Addlestone ‚Üî London Waterloo">
                        <span class="pill-icon">‚≠ê</span>
                        <span class="label">Addlestone ‚Üî Waterloo</span>
                    </button>
                    <button class="pill-button" onclick="selectPrimaryRoute('WBY', 'LST')" title="Weybridge ‚Üî London Waterloo">
                        <span class="pill-icon">üöâ</span>
                        <span class="label">Weybridge ‚Üî Waterloo</span>
                    </button>
                    <button class="pill-button" onclick="selectPrimaryRoute('STN', 'LST')" title="Staines ‚Üî London Waterloo">
                        <span class="pill-icon">üõ´</span>
                        <span class="label">Staines ‚Üî Waterloo</span>
                    </button>
                </div>
                <button class="pill-button disabled" title="Custom routes coming soon">
                    <span class="pill-icon swap-icon">üîÅ</span>
                    <span class="label">Custom route</span>
                    <span class="pill-subtext">(soon)</span>
                </button>
            </div>
            
            <div class="content-card">
                <div class="tabs">
                    <button id="tabRoutes" class="tab-button active" onclick="showRoutes()">
                        <span class="icon">üß≠</span>
                        <span class="label">Routes</span>
                    </button>
                    <button id="tabJourneys" class="tab-button" onclick="showJourneys()">
                        <span class="icon">üìç</span>
                        <span class="label">Live journeys</span>
                    </button>
                </div>
                
                <div id="routesView" class="routes-list">
                    <div class="route-card" onclick="selectRoute('ADD','LST')">
                        <div class="route-title">
                            <div class="route-main">Addlestone ‚Üí Waterloo</div>
                            <div class="route-badge">
                                <span class="icon">‚¨ÜÔ∏è</span>
                                <span>Direct & via Weybridge</span>
                            </div>
                        </div>
                        <div class="route-meta">
                            <div class="route-meta-left">
                                <span>Fastest ~ <span class="route-time-estimate"><span>43</span> mins</span></span>
                                <span class="route-meta-dot"></span>
                                <span>Usually 1 change</span>
                            </div>
                            <div class="route-time-estimate">
                                Typical: <span>49‚Äì55</span> mins
                            </div>
                        </div>
                        <div class="route-footnote">
                            <strong>Smart routing:</strong> looks at Addlestone ‚Üí Weybridge ‚Üí Waterloo connections.
                        </div>
                    </div>
                    
                    <div class="route-card" onclick="selectRoute('ADD','WBY')">
                        <div class="route-title">
                            <div class="route-main">Addlestone ‚Üí Weybridge</div>
                            <div class="route-badge">
                                <span class="icon">üöâ</span>
                                <span>Local shuttle</span>
                            </div>
                        </div>
                        <div class="route-meta">
                            <div class="route-meta-left">
                                <span>Direct shuttle</span>
                            </div>
                            <div class="route-time-estimate">
                                Typical: <span>5‚Äì7</span> mins
                            </div>
                        </div>
                        <div class="route-footnote">
                            Good for connecting onto faster mainline services.
                        </div>
                    </div>
                    
                    <div class="route-card" onclick="selectRoute('WBY','LST')">
                        <div class="route-title">
                            <div class="route-main">Weybridge ‚Üí Waterloo</div>
                            <div class="route-badge">
                                <span class="icon">‚ö°Ô∏è</span>
                                <span>Mainline fast</span>
                            </div>
                        </div>
                        <div class="route-meta">
                            <div class="route-meta-left">
                                <span>Fastest ~ <span class="route-time-estimate"><span>30</span> mins</span></span>
                                <span class="route-meta-dot"></span>
                                <span>Mostly direct</span>
                            </div>
                            <div class="route-time-estimate">
                                Typical: <span>30‚Äì40</span> mins
                            </div>
                        </div>
                        <div class="route-footnote">
                            Use in combination with Addlestone ‚Üí Weybridge to beat the slow stopper.
                        </div>
                    </div>
                    
                    <div class="route-card" onclick="selectRoute('STN','LST')">
                        <div class="route-title">
                            <div class="route-main">Staines ‚Üí Waterloo</div>
                            <div class="route-badge">
                                <span class="icon">‚úàÔ∏è</span>
                                <span>Via Twickenham / Richmond</span>
                            </div>
                        </div>
                        <div class="route-meta">
                            <div class="route-meta-left">
                                <span>Direct or semi-fast</span>
                            </div>
                            <div class="route-time-estimate">
                                Typical: <span>35‚Äì45</span> mins
                            </div>
                        </div>
                        <div class="route-footnote">
                            Handy if you're starting from the Staines / Heathrow side.
                        </div>
                    </div>
                </div>
                
                <div id="journeysView" class="results-view" style="display: none;">
                    <div class="results-header">
                        <div>
                            <h2 id="journeyTitle">Live departures</h2>
                            <div id="journeySubtitle" class="results-header-subtitle">Choose a route to begin</div>
                        </div>
                        <div class="update-info">
                            <span id="lastUpdated" class="update-pill">Updated ‚Äî</span>
                            <button class="refresh-btn small" onclick="refreshTrains()">
                                <span class="icon">‚Üª</span>
                                <span>Refresh</span>
                            </button>
                        </div>
                    </div>
                    <div id="journeyContent" class="journeys-container">
                        <div class="no-results">
                            <strong>No route selected.</strong>
                            <small>Select a route above to see live trains.</small>
                        </div>
                    </div>
                </div>
                
                <div class="loading" id="loading" style="display: none;">
                    <div class="spinner"></div>
                    <div>Loading train times...</div>
                </div>
            </div>
        </main>
        
        <footer class="footer">
            <div>
                <span class="highlight">South Western Railway</span> timetable logic ¬∑ experimental helper
            </div>
            <div>
                Data via <span class="highlight">National Rail Enquiries</span> ¬∑ unofficial
            </div>
        </footer>
    </div>

    <script>
        const STATION_CODES = {
            ADD: 'Addlestone',
            WBY: 'Weybridge',
            LST: 'London Waterloo',
            STN: 'Staines'
        };
        
        const stationNames = STATION_CODES;
        
        const WORKER_URL = 'https://train-times-huxley.paullroberts.workers.dev/';
        
        let currentFrom = null;
        let currentTo = null;
        let isCombinedRoute = false;
        let combinedRouteVia = null;
        let currentTrains = [];
        let autoRefreshInterval = null;
        let lastUpdateTime = null;
        let hasAnnouncedCurrentTrain = false;
        
        let voiceEnabled = false;
        let britishVoice = null;
        let voicesLoaded = false;
        
        function initVoices() {
            if (!('speechSynthesis' in window)) {
                console.warn('Text-to-speech not supported');
                return;
            }
            
            function loadVoices() {
                const voices = window.speechSynthesis.getVoices();
                if (!voices || voices.length === 0) {
                    return;
                }
                britishVoice = voices.find(v => 
                    v.lang && v.lang.toLowerCase().startsWith('en-gb')
                ) || voices.find(v => v.lang && v.lang.toLowerCase().startsWith('en'));
                
                voicesLoaded = true;
                updateVoiceButton();
            }
            
            loadVoices();
            
            window.speechSynthesis.onvoiceschanged = () => {
                if (!voicesLoaded) {
                    loadVoices();
                }
            };
        }
        
        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            if (voiceEnabled && !voicesLoaded) {
                initVoices();
            }
            updateVoiceButton();
        }
        
        function updateVoiceButton() {
            const btn = document.getElementById('voiceToggle');
            if (!btn) return;
            
            if (voiceEnabled) {
                btn.classList.add('active');
                btn.innerHTML = '<span class="voice-toggle-icon">üîä</span><span>Voice on</span>';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<span class="voice-toggle-icon">üîà</span><span>Voice off</span>';
            }
        }
        
        function speak(text) {
            if (!voiceEnabled || !('speechSynthesis' in window)) return;
            if (!text) return;
            
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.02;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            if (britishVoice) {
                utterance.voice = britishVoice;
            }
            
            window.speechSynthesis.speak(utterance);
        }
        
        function announceHeroTrain(train) {
            if (!voiceEnabled) return;
            
            const std = train.std;
            const etd = train.etd;
            const destName = train.destination && train.destination[0] ? train.destination[0].locationName : 'Unknown';
            const platform = train.platform || 'to be confirmed';
            
            let announcement = '';
            
            if (isCombinedRoute) {
                // For combined routes, announce the connection
                announcement = `The next train to ${stationNames[currentTo]} via ${stationNames[combinedRouteVia]} `;
                announcement += `departs at ${std.replace(':', ' ')} from platform ${platform}`;
            } else {
                announcement = `The next train to ${destName} departs at ${std.replace(':', ' ')} from platform ${platform}`;
            }
            
            // Add countdown if available
            const countdown = calculateCountdown(std, etd);
            if (countdown && etd !== 'Cancelled') {
                // Convert countdown text for better voice pronunciation
                let countdownText = countdown.replace('Departs in ', '');
                // Replace "1h 23m" with "1 hour 23 minutes"
                countdownText = countdownText.replace(/(\d+)h\s+(\d+)m/, function(match, hours, mins) {
                    const hourText = hours === '1' ? 'hour' : 'hours';
                    const minText = mins === '1' ? 'minute' : 'minutes';
                    return `${hours} ${hourText} ${mins} ${minText}`;
                });
                // Replace standalone "23m" with "23 minutes"
                countdownText = countdownText.replace(/^(\d+)m$/, function(match, mins) {
                    return mins === '1' ? '1 minute' : `${mins} minutes`;
                });
                // Replace "23 mins" with "23 minutes" (from calculateCountdown)
                countdownText = countdownText.replace(/(\d+)\s+mins/, function(match, mins) {
                    return mins === '1' ? '1 minute' : `${mins} minutes`;
                });
                // Replace "1 min" with "1 minute"
                countdownText = countdownText.replace(/1\s+min$/, '1 minute');
                // ‚úÖ Make the phrase natural: "departing in X minutes"
                announcement += `, departing in ${countdownText}`;
            }
            
            // Add delay/cancellation info
            if (etd === 'Cancelled') {
                announcement = `This service has been cancelled. ${announcement}`;
            } else if (etd && etd.includes(':') && etd !== std) {
                announcement += `. This train is delayed and is now expected at ${etd.replace(':', ' ')}`;
            }
            
            speak(announcement);
        }
        
        function announceConnection(connection) {
            if (!voiceEnabled) return;
            
            const leg1 = connection.leg1;
            const connectionMins = connection.connectionTime;
            
            let announcement = `The next connection to ${stationNames[currentTo]} `;
            announcement += `goes via ${stationNames[combinedRouteVia]}. `;
            announcement += `Your first train departs at ${leg1.std.replace(':', ' ')}`;
            
            if (leg1.platform) {
                announcement += ` from platform ${leg1.platform}`;
            } else {
                announcement += ` from a platform to be confirmed`;
            }
            
            if (connectionMins !== null && connectionMins !== undefined) {
                announcement += `. You'll have a ${connectionMins} minute connection at ${stationNames[combinedRouteVia]}.`;
            }
            
            speak(announcement);
        }
        
        function selectPrimaryRoute(from, to) {
            selectRoute(from, to);
            showJourneys();
        }
        
        function showRoutes() {
            document.getElementById('routesView').style.display = 'block';
            document.getElementById('journeysView').style.display = 'none';
            document.getElementById('tabRoutes').classList.add('active');
            document.getElementById('tabJourneys').classList.remove('active');
        }
        
        function showJourneys() {
            document.getElementById('routesView').style.display = 'none';
            document.getElementById('journeysView').style.display = 'flex';
            document.getElementById('tabRoutes').classList.remove('active');
            document.getElementById('tabJourneys').classList.add('active');
        }
        
        function selectRoute(from, to) {
            currentFrom = from;
            currentTo = to;
            isCombinedRoute = false;
            combinedRouteVia = null;
            hasAnnouncedCurrentTrain = false;
            
            updateJourneyHeader();
            getTrains(from, to);
        }
        
        function selectCombinedRoute(from, via, to) {
            currentFrom = from;
            currentTo = to;
            isCombinedRoute = true;
            combinedRouteVia = via;
            hasAnnouncedCurrentTrain = false;
            
            updateJourneyHeader();
            getCombinedRoute(from, via, to);
        }
        
        function updateJourneyHeader() {
            const titleEl = document.getElementById('journeyTitle');
            const subtitleEl = document.getElementById('journeySubtitle');
            
            if (!currentFrom || !currentTo) {
                titleEl.textContent = 'Live departures';
                subtitleEl.textContent = 'Choose a route to begin';
                return;
            }
            
            const fromName = stationNames[currentFrom] || currentFrom;
            const toName = stationNames[currentTo] || currentTo;
            
            if (isCombinedRoute && combinedRouteVia) {
                const viaName = stationNames[combinedRouteVia] || combinedRouteVia;
                titleEl.innerHTML = `Live: <span>${fromName} ‚Üí ${toName}</span>`;
                subtitleEl.textContent = `Smart connection via ${viaName}`;
            } else {
                titleEl.innerHTML = `Live: <span>${fromName} ‚Üí ${toName}</span>`;
                subtitleEl.textContent = 'Direct and fastest available services';
            }
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function setLastUpdated() {
            lastUpdateTime = new Date();
            const el = document.getElementById('lastUpdated');
            if (!el) return;
            
            el.textContent = `Updated ${formatUpdateTime(lastUpdateTime)}`;
        }
        
        function formatUpdateTime(time) {
            if (!time) return '‚Äî';
            const now = new Date();
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins === 0) return 'just now';
            if (diffMins === 1) return '1 min ago';
            if (diffMins < 60) return `${diffMins} mins ago`;
            
            const hours = Math.floor(diffMins / 60);
            if (hours === 1) return '1 hour ago';
            return `${hours} hours ago`;
        }
        
        function calculateCountdown(std, etd) {
            if (!std) return '';
            
            const now = new Date();
            const [hours, minutes] = std.split(':').map(Number);
            
            const depTime = new Date(now);
            depTime.setHours(hours, minutes, 0, 0);
            
            if (depTime < now) {
                depTime.setDate(depTime.getDate() + 1);
            }
            
            const diffMs = depTime - now;
            const diffMins = Math.round(diffMs / 60000);
            
            if (diffMins < 0) return '';
            
            if (diffMins < 60) {
                if (etd === 'Cancelled') {
                    return 'Cancelled';
                }
                if (diffMins === 0) {
                    return 'Departs now';
                }
                if (diffMins === 1) {
                    return 'Departs in 1 min';
                }
                return `Departs in ${diffMins} mins`;
            } else {
                const hours = Math.floor(diffMins / 60);
                const mins = diffMins % 60;
                if (mins === 0) {
                    return `Departs in ${hours}h`;
                } else {
                    return `Departs in ${hours}h ${mins}m`;
                }
            }
        }
        
        function calculateTimeDifference(startTime, endTime) {
            if (!startTime || !endTime) return NaN;
            
            const now = new Date();
            const [startHours, startMinutes] = startTime.split(':').map(Number);
            const [endHours, endMinutes] = endTime.split(':').map(Number);
            
            const start = new Date(now);
            start.setHours(startHours, startMinutes, 0, 0);
            
            const end = new Date(now);
            end.setHours(endHours, endMinutes, 0, 0);
            
            if (end < start) {
                end.setDate(end.getDate() + 1);
            }
            
            return Math.round((end - start) / 60000);
        }
        
        function getArrivalTime(service, stationCode) {
            if (!service || !service.subsequentCallingPoints || !service.subsequentCallingPoints[0]) {
                return null;
            }
            
            const callingPoints = service.subsequentCallingPoints[0].callingPoint;
            if (!callingPoints) return null;
            
            const point = callingPoints.find(p => p.crs === stationCode);
            return point ? (point.st || point.et || null) : null;
        }
        
        async function getTrains(from, to) {
            if (!from || !to) return;
            
            stopAutoRefresh();
            
            showLoading();
            const content = document.getElementById('journeyContent');
            content.innerHTML = '';
            
            try {
                const response = await fetch(`${WORKER_URL}?from=${from}&to=${to}`);
                if (!response.ok) {
                    throw new Error(`Network error: ${response.status}`);
                }
                const data = await response.json();
                hideLoading();
                
                currentTrains = data.services || [];
                setLastUpdated();
                
                displayJourney(from, to, data);
                
                autoRefreshInterval = setInterval(() => {
                    getTrains(from, to);
                }, 60000);
            } catch (error) {
                hideLoading();
                console.error('Error fetching train data:', error);
                content.innerHTML = `
                    <div class="no-results">
                        <strong>Could not load trains.</strong>
                        <small>${error.message || 'Please try again in a moment.'}</small>
                    </div>
                `;
            }
        }
        
        async function getCombinedRoute(from, via, to) {
            if (!from || !via || !to) return;
            
            stopAutoRefresh();
            
            showLoading();
            const content = document.getElementById('journeyContent');
            content.innerHTML = '';
            
            try {
                const response = await fetch(`${WORKER_URL}?from=${from}&via=${via}&to=${to}`);
                if (!response.ok) {
                    throw new Error(`Network error: ${response.status}`);
                }
                const data = await response.json();
                hideLoading();
                
                currentTrains = data.connections || [];
                setLastUpdated();
                
                displayCombinedJourney(from, via, to, data);
                
                autoRefreshInterval = setInterval(() => {
                    getCombinedRoute(from, via, to);
                }, 60000);
            } catch (error) {
                hideLoading();
                console.error('Error fetching combined route data:', error);
                content.innerHTML = `
                    <div class="no-results">
                        <strong>Could not load connections.</strong>
                        <small>${error.message || 'Please try again in a moment.'}</small>
                    </div>
                `;
            }
        }
        
        function displayJourney(from, to, data) {
            const content = document.getElementById('journeyContent');
            
            const fromName = stationNames[from] || from;
            const toName = stationNames[to] || to;
            
            let html = '';
            
            const directServices = data.services || [];
            
            if (from === 'ADD' && to === 'LST') {
                const heroHtml = `
                    <div class="hero-journey">
                        <div class="hero-label">
                            <div class="hero-label-left">
                                <span>Smart Addlestone ‚Üí Waterloo routing</span>
                            </div>
                            <button class="refresh-btn small" onclick="selectCombinedRoute('ADD','WBY','LST')">
                                <span class="icon">üß†</span>
                                <span>Try via Weybridge</span>
                            </button>
                        </div>
                        <div class="hero-main">
                            <div class="hero-times">
                                <div class="hero-route">Direct stopper from Addlestone</div>
                                <div class="hero-subtitle">
                                    Use <strong>Addlestone ‚Üí Weybridge ‚Üí Waterloo</strong> for faster options.
                                </div>
                            </div>
                        </div>
                        <div class="route-breadcrumbs">
                            <span class="crumb">
                                <span class="icon">1Ô∏è‚É£</span>
                                <span>${stationNames['ADD']} ‚Üí ${stationNames['WBY']}</span>
                            </span>
                            <span class="crumb">
                                <span class="icon">2Ô∏è‚É£</span>
                                <span>${stationNames['WBY']} ‚Üí ${stationNames['LST']}</span>
                            </span>
                        </div>
                    </div>
                `;
                html += heroHtml;
            }
            
            if (!directServices || directServices.length === 0) {
                html += `
                    <div class="no-results">
                        <strong>No direct trains found from ${fromName} to ${toName} in the next hour.</strong>
                        <small>Showing all departures from ${fromName} instead.</small>
                    </div>
                `;
                
                if (data.allFromStation && data.allFromStation.departures) {
                    html += displayAllDepartures(data.allFromStation, to);
                }
                
                content.innerHTML = html;
                return;
            }
            
            const directTrain = directServices[0];
            const std = directTrain.std;
            const etd = directTrain.etd;
            const platform = directTrain.platform;
            const destName = directTrain.destination && directTrain.destination[0] ? directTrain.destination[0].locationName : toName;
            
            const countdown = calculateCountdown(std, etd);
            
            let statusBadgeHtml = '';
            if (etd === 'Cancelled') {
                statusBadgeHtml = '<span class="status-badge status-cancelled">Cancelled</span>';
            } else if (etd && etd.includes(':') && etd !== std) {
                statusBadgeHtml = `<span class="status-badge status-delayed">Delayed to ${etd}</span>`;
            } else {
                statusBadgeHtml = '<span class="status-badge status-ontime">On time</span>';
            }
            
            html += `
                <div class="hero-journey">
                    <div class="hero-label">
                        <div class="hero-label-left">
                            <span class="hero-label-badge">
                                <span class="icon">‚≠ê</span>
                                <span>Best direct option</span>
                            </span>
                            <span>Direct from ${fromName} to ${toName}</span>
                        </div>
                        <button class="speak-btn" onclick="announceHeroTrain(currentTrains[0])" title="Announce this train">
                            üîä
                        </button>
                    </div>
                    <div class="hero-main">
                        <div class="hero-times">
                            <div class="hero-main-time">${std}</div>
                            <div class="hero-route">${fromName} ‚Üí ${destName}</div>
                            <div class="hero-subtitle">
                                Direct service from ${fromName} to ${toName}
                                ${statusBadgeHtml}
                            </div>
                            <div class="hero-meta">
                                <span>Calling pattern available in National Rail app</span>
                            </div>
                        </div>
                        <div>
                            <div class="hero-platform ${platform ? '' : 'tbc'}">
                                ${platform ? `Platform ${platform}` : 'Platform TBC'}
                            </div>
                        </div>
                    </div>
                    ${countdown ? `<div class="hero-countdown"><span class="icon">‚è±</span><span>${countdown}</span></div>` : ''}
                </div>
            `;
            
            html += '<div class="journey-list">';
            
            directServices.slice(0, 5).forEach(service => {
                const serviceStd = service.std;
                const serviceEtd = service.etd;
                const servicePlatform = service.platform;
                
                const serviceCountdown = calculateCountdown(serviceStd, serviceEtd);
                
                let serviceStatusBadge = '';
                if (serviceEtd === 'Cancelled') {
                    serviceStatusBadge = '<span class="status-badge status-cancelled">Cancelled</span>';
                } else if (serviceEtd && serviceEtd.includes(':') && serviceEtd !== serviceStd) {
                    serviceStatusBadge = `<span class="status-badge status-delayed">Delayed to ${serviceEtd}</span>`;
                } else {
                    serviceStatusBadge = '<span class="status-badge status-ontime">On time</span>';
                }
                
                html += `
                    <div class="journey-card">
                        <div class="journey-header">
                            <div class="journey-times">
                                <div class="journey-main-time">${serviceStd}</div>
                                <div class="journey-subtitle">
                                    ${fromName} ‚Üí ${destName}
                                    ${serviceStatusBadge}
                                </div>
                            </div>
                            <div class="journey-platform">
                                ${servicePlatform ? `Platform ${servicePlatform}` : 'Platform TBC'}
                            </div>
                        </div>
                        <div class="journey-body">
                            <div class="journey-details">
                                <div>See calling pattern in the National Rail app</div>
                                ${service.operator ? `<div class="journey-operator">Operator: ${service.operator}</div>` : ''}
                            </div>
                            <div class="journey-summary">
                                ${serviceCountdown ? `<div><span class="time">${serviceCountdown}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            content.innerHTML = html;
            
            if (directTrain && !hasAnnouncedCurrentTrain && voiceEnabled) {
                setTimeout(() => announceHeroTrain(directTrain), 500);
                hasAnnouncedCurrentTrain = true;
            }
        }
        
        function displayAllDepartures(allFromStation, to) {
            const fromName = allFromStation.locationName || 'This station';
            const toName = stationNames[to] || to;
            
            const services = allFromStation.departures.all || [];
            if (!services || services.length === 0) {
                return `
                    <div class="no-results">
                        <strong>No trains found from ${fromName} in the next hour.</strong>
                    </div>
                `;
            }
            
            let html = `
                <div class="no-results">
                    <strong>Showing all trains from ${fromName}.</strong>
                    <small>Tap a service in the National Rail app to see if it calls at ${toName}.</small>
                </div>
                <div class="all-trains-list">
            `;
            
            services.slice(0, 8).forEach(service => {
                const std = service.std;
                const etd = service.etd;
                const destName = service.destination && service.destination[0] ? service.destination[0].locationName : 'Unknown';
                const platform = service.platform;
                
                const countdown = calculateCountdown(std, etd);
                
                let serviceStatusBadge = '';
                if (etd === 'Cancelled') {
                    serviceStatusBadge = '<span class="status-badge status-cancelled">Cancelled</span>';
                } else if (etd && etd.includes(':') && etd !== std) {
                    serviceStatusBadge = `<span class="status-badge status-delayed">Delayed to ${etd}</span>`;
                } else {
                    serviceStatusBadge = '<span class="status-badge status-ontime">On time</span>';
                }
                
                html += `
                    <div class="all-trains-card">
                        <div class="all-trains-header">
                            <div>
                                <div class="all-trains-main-time">${std}</div>
                                <div class="all-trains-destination">${fromName} ‚Üí ${destName}</div>
                            </div>
                            <div>
                                <div class="journey-platform">
                                    ${platform ? `Plat ${platform}` : 'Plat TBC'}
                                </div>
                            </div>
                        </div>
                        <div class="all-trains-meta">
                            <div>
                                ${serviceStatusBadge}
                            </div>
                            <div>
                                ${countdown ? `<span class="time">${countdown}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        function displayCombinedJourney(from, via, to, data) {
            const content = document.getElementById('journeyContent');
            
            const fromName = stationNames[from] || from;
            const viaName = stationNames[via] || via;
            const toName = stationNames[to] || to;
            
            let html = '';
            
            const connections = data.connections || [];
            
            if (!connections || connections.length === 0) {
                html += `
                    <div class="no-results">
                        <strong>No good connections found via ${viaName} in the next hour.</strong>
                        <small>Showing direct trains from ${fromName} instead.</small>
                    </div>
                `;
                
                if (data.directServices && data.directServices.services) {
                    const fakeData = { services: data.directServices.services };
                    html += '<div class="journey-list">';
                    const originalContent = document.createElement('div');
                    originalContent.id = 'tempJourneyContent';
                    document.body.appendChild(originalContent);
                    displayJourney(from, to, fakeData);
                    const tempContent = document.getElementById('journeyContent');
                    if (tempContent) {
                        html += tempContent.innerHTML;
                    }
                    document.body.removeChild(originalContent);
                }
                
                content.innerHTML = html;
                return;
            }
            
            const heroConnection = connections[0];
            
            const leg1 = heroConnection.leg1;
            const leg2 = heroConnection.leg2;
            const std = leg1.std;
            const viaArrival = heroConnection.arrivalAtVia;
            const finalArrival = heroConnection.arrivalAtDestination;
            const connectionMins = heroConnection.connectionTime;
            
            const totalMins = calculateTimeDifference(std, finalArrival);
            const totalHours = Math.floor(totalMins / 60);
            const totalMinsRemainder = totalMins % 60;
            const totalTimeStr = totalHours > 0 ? `${totalHours}h ${totalMinsRemainder}m` : `${totalMinsRemainder}m`;
            
            const countdown = calculateCountdown(std, leg1.etd);
            
            let connectionBadge = '';
            if (connectionMins < 7) {
                connectionBadge = `<span class="status-badge status-delayed">Tight ${connectionMins} min connection</span>`;
            } else if (connectionMins >= 15) {
                connectionBadge = `<span class="status-badge status-ontime">Comfortable ${connectionMins} min connection</span>`;
            } else {
                connectionBadge = `<span class="status-badge status-ontime">${connectionMins} min connection</span>`;
            }
            
            html += `
                <div class="hero-journey">
                    <div class="hero-label">
                        <div class="hero-label-left">
                            <span class="hero-label-badge">
                                <span class="icon">üß†</span>
                                <span>Smart connection</span>
                            </span>
                            <span>${fromName} ‚Üí ${toName} via ${viaName}</span>
                        </div>
                        <button class="speak-btn" onclick="announceConnection(currentTrains[0])" title="Announce this connection">
                            üîä
                        </button>
                    </div>
                    <div class="hero-main">
                        <div class="hero-times">
                            <div class="hero-main-time">${std}</div>
                            <div class="hero-route">${fromName} ‚Üí ${viaName} ‚Üí ${toName}</div>
                            <div class="hero-subtitle">
                                Connect at ${viaName}
                                ${connectionBadge}
                            </div>
                            <div class="hero-meta">
                                <span>Total journey ~ ${totalTimeStr}</span>
                                <span class="hero-meta-dot"></span>
                                <span>Change at ${viaName}</span>
                            </div>
                        </div>
                        <div>
                            <div class="hero-platform ${leg1.platform ? '' : 'tbc'}">
                                ${leg1.platform ? `Platform ${leg1.platform}` : 'Platform TBC'}
                            </div>
                        </div>
                    </div>
                    ${countdown ? `<div class="hero-countdown"><span class="icon">‚è±</span><span>${countdown}</span></div>` : ''}
                    <div class="route-breadcrumbs">
                        <span class="crumb">
                            <span class="icon">1Ô∏è‚É£</span>
                            <span>${fromName} ‚Üí ${viaName}</span>
                        </span>
                        <span class="crumb">
                            <span class="icon">2Ô∏è‚É£</span>
                            <span>${viaName} ‚Üí ${toName}</span>
                        </span>
                    </div>
                </div>
            `;
            
            displayCombinedJourneys(html, content);
        }
        
        function displayCombinedJourneys(htmlPrefix, content) {
            let html = htmlPrefix;
            
            // Show top 2 recommended connections as hero cards
            const topConnections = currentTrains.slice(0, Math.min(2, currentTrains.length));
            
            // Render hero connections with correct index so the speak button refers to the right one
            topConnections.forEach((connection, idx) => {
                html += renderCombinedJourney(connection, idx === 0, idx);
            });
            
            // Auto-announce the first connection
            if (topConnections.length > 0 && !hasAnnouncedCurrentTrain) {
                setTimeout(() => announceConnection(topConnections[0]), 500);
                hasAnnouncedCurrentTrain = true;
            }
            
            // Show other connections
            if (currentTrains.length > 2) {
                html += `<div class="other-trains-header">OTHER CONNECTIONS</div>`;
                currentTrains.slice(2).forEach((connection, idx) => {
                    const absoluteIndex = idx + 2;
                    html += renderCombinedJourney(connection, false, absoluteIndex);
                });
            }
            
            html += `
                <button class="back-btn" onclick="goBack()">
                    ‚Üê Back to Routes
                </button>
            `;
            
            content.innerHTML = html;
        }
        
        function renderCombinedJourney(connection, isHero, idx) {
            const leg1 = connection.leg1;
            const leg2 = connection.leg2;
            const connectionMins = connection.connectionTime;
            
            // Calculate total journey time with a safe fallback if the final arrival time cannot be found
            let arrivalForTotal = leg2.sta || getArrivalTime(leg2, currentTo) || leg2.std;
            const totalMins = calculateTimeDifference(leg1.std, arrivalForTotal);
            const totalHours = Math.floor(totalMins / 60);
            const totalMinsRemainder = totalMins % 60;
            const totalTimeStr = isNaN(totalMins)
                ? '‚Äî'
                : (totalHours > 0 ? `${totalHours}h ${totalMinsRemainder}m` : `${totalMinsRemainder}m`);
            
            // Determine connection quality
            let connectionClass = 'good';
            let connectionLabel = `${connectionMins} min connection`;
            if (connectionMins < 7) {
                connectionClass = 'tight';
                connectionLabel = `‚ö†Ô∏è Tight ${connectionMins} min connection`;
            } else if (connectionMins >= 15) {
                connectionLabel = `‚úì Comfortable ${connectionMins} min connection`;
            }
            
            const countdown = calculateCountdown(leg1.std, leg1.etd);
            
            return `
                <div class="combined-journey">
                    ${isHero ? `<div class="hero-label">
                        ‚≠ê RECOMMENDED CONNECTION
                        <button class="speak-btn"
                            onclick="announceConnection(currentTrains[${idx}])"
                            title="Announce this connection">üîä</button>
                    </div>` : ''}
                    ${countdown ? `<div class="hero-countdown">${countdown}</div>` : ''}
                    
                    <div class="combined-leg">
                        <div class="leg-header">
                            <div>
                                <div class="leg-time">${leg1.std}</div>
                                <div><strong>${stationNames[currentFrom]} ‚Üí ${stationNames[combinedRouteVia]}</strong></div>
                            </div>
                            ${leg1.platform
                                ? `<div class="platform">Platform ${leg1.platform}</div>`
                                : `<div class="platform-tbd">Platform TBC</div>`}
                        </div>
                        <div>Arrives ${stationNames[combinedRouteVia]}: ${connection.arrivalAtVia}</div>
                        ${leg1.operator ? `<div style="font-size: 14px; color: #666;">Operator: ${leg1.operator}</div>` : ''}
                    </div>
                    
                    <div class="connection-time ${connectionClass}">
                        ${connectionLabel} at ${stationNames[combinedRouteVia]}
                    </div>
                    
                    <div class="combined-leg">
                        <div class="leg-header">
                            <div>
                                <div class="leg-time">${leg2.std}</div>
                                <div><strong>${stationNames[combinedRouteVia]} ‚Üí ${stationNames[currentTo]}</strong></div>
                            </div>
                            ${leg2.platform
                                ? `<div class="platform">Platform ${leg2.platform}</div>`
                                : `<div class="platform-tbd">Platform TBC</div>`}
                        </div>
                        ${leg2.operator ? `<div style="font-size: 14px; color: #666;">Operator: ${leg2.operator}</div>` : ''}
                    </div>
                    
                    <div class="total-journey-time">
                        Total journey time: ${totalTimeStr}
                    </div>
                </div>
            `;
        }
        
        function goBack() {
            stopAutoRefresh();
            isCombinedRoute = false;
            combinedRouteVia = null;
            hasAnnouncedCurrentTrain = false;
            
            if (currentFrom && currentTo) {
                selectRoute(currentFrom, currentTo);
            } else {
                document.getElementById('journeyContent').innerHTML = `
                    <div class="no-results">
                        <strong>No route selected.</strong>
                        <small>Select a route above to see live trains.</small>
                    </div>
                `;
            }
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        function refreshTrains() {
            if (!currentFrom || !currentTo) return;
            
            if (isCombinedRoute && combinedRouteVia) {
                getCombinedRoute(currentFrom, combinedRouteVia, currentTo);
            } else {
                getTrains(currentFrom, currentTo);
            }
        }
        
        window.addEventListener('load', () => {
            initVoices();
            updateVoiceButton();
            
            const savedTab = localStorage.getItem('lastTab');
            if (savedTab === 'journeys') {
                showJourneys();
            } else {
                showRoutes();
            }
            
            setInterval(() => {
                if (lastUpdateTime) {
                    const el = document.getElementById('lastUpdated');
                    if (el) {
                        el.textContent = `Updated ${formatUpdateTime(lastUpdateTime)}`;
                    }
                }
            }, 30000);
        });
        
        document.getElementById('tabRoutes').addEventListener('click', () => {
            localStorage.setItem('lastTab', 'routes');
        });
        
        document.getElementById('tabJourneys').addEventListener('click', () => {
            localStorage.setItem('lastTab', 'journeys');
        });
        
        if ('speechSynthesis' in window) {
            speechSynthesis.addEventListener('voiceschanged', () => {
                if (!voicesLoaded) {
                    initVoices();
                }
            });
        }
    </script>
</body>
</html>
